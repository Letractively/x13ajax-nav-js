/*
GNU GPL 3: http://www.gnu.org/licenses/gpl.html
 @contacts					klyde13[]gmail.com

 {
  Требует чтобы ajax-ответ с сервера являлся JSON-объектом со следующими полями:
   ~ controller 		- имя контроллера
   ~ method 			- имя метода
   ~ content 			- контент для страницы
   ~ [title] 			- опциональное поле, title для страницы
   ~ [destinationNode] - опциональное поле, определяющее целевой html-элемент
 }

 @param object	params -	объект для хранения служебной информации
 @param object jQuery -	объект jQuery
 @class x13AjaxNav
 @constructor
*/
window.$$$=function(){return function x13AjaxNav(params,jQuery){var _this=this;_this.params=params;_this.jQuery=jQuery;this.navEffect=function(){};this.navDisEffect=function(){};this.processAjaxResponse=function(d){if(typeof d.redirect!="undefined"){history.replaceState(null,null,link);return _this.processInternalLink(d.redirect,true)}_this.params.controller=d.controller;_this.params.method=d.method;if(typeof d.title!="undefined")this.jQuery("title").html(d.title);if(typeof d.content!="undefined"){var destinationNode;
if(typeof d.destinationNode!="undefined")destinationNode=d.destinationNode;else destinationNode=_this.jQuery("#showContentSpan")?"#showContentSpan":"body";_this.jQuery(destinationNode).html(d.content)}if(typeof _this.processAjaxResponseInterlayer=="function")_this.processAjaxResponseInterlayer(d);_this.reloaded();_this.lastOk=true};this.processAjaxResponseInterlayer=function(d){};this.processError=function(e){alert("\u043e\u0448\u0438\u0431\u043a\u0430 \u0432\u044b\u043f\u043e\u043b\u043d\u0435\u043d\u0438\u044f \u0437\u0430\u043f\u0440\u043e\u0441\u0430")};
this.isBaseURL=function(url){return(url+"").toLowerCase().indexOf(_this.params.base_url.toLowerCase())===0};this.processInternalLink=function(link){if(!_this.isBaseURL(link))return false;_this.lastOk=false;if(typeof _this.navEffect=="function")_this.navEffect();$.ajax({type:"GET",dataType:"JSON",url:link,async:false,success:_this.processAjaxResponse,error:_this.processError});if(typeof _this.navEffect=="function")_this.navDisEffect();return _this.lastOk};this.linkClick=function(e){var el=_this.jQuery(e.target);
if(el.prop("tagName")==="IMG"&&el.parent().prop("tagName")==="A")el=_this.jQuery(el.parent());if(el.prop("tagName")!=="A")return true;var href=el.prop("href");if(!_this.isBaseURL(href))return true;if(!el.hasClass("ajaxNav")&&!el.parent().hasClass("ajaxNav"))return true;if(_this.processInternalLink(href))history.pushState(null,null,href);e.stopPropagation();return false};this.reloaded=function(){var k;for(var k in _this.rebinds["*"])_this.rebinds["*"][k]();indBind=_this.params.controller.toLowerCase();
for(k in _this.rebinds["ccontroller"][indBind])_this.rebinds["ccontroller"][indBind][k]();var indBind=(_this.params.controller+"/"+_this.params.method).toLowerCase();for(k in _this.rebinds["controller_and_method"][indBind])_this.rebinds["controller_and_method"][indBind][k]();var indBind=_this.params.method.toLowerCase();for(k in _this.rebinds["method"][indBind])_this.rebinds["method"][indBind][k]()};this.$=function(dest,callBack){if(_this.rebinds==undefined)_this.rebinds={};if(_this.rebinds["*"]==
undefined)_this.rebinds["*"]=[];if(_this.rebinds["method"]==undefined)_this.rebinds["method"]={};if(_this.rebinds["ccontroller"]==undefined)_this.rebinds["ccontroller"]={};if(_this.rebinds["controller_and_method"]==undefined)_this.rebinds["controller_and_method"]={};if(dest=="*"){_this.rebinds["*"].push(callBack);return true}dest=dest.split("/");if((dest[0]=="*"||dest[0]==""||dest[0]==undefined)&&(dest[1]!=""||dest[1]!=undefined)){if(_this.rebinds["method"][dest[1]]==undefined)_this.rebinds["method"][dest[1]]=
[];_this.rebinds["method"][dest[1]].push(callBack);return true}if((dest[0]!=""||dest[0]!=undefined)&&(dest[1]=="*"||dest[1]==""||dest[1]==undefined)){if(_this.rebinds["ccontroller"][dest[0]]==undefined)_this.rebinds["ccontroller"][dest[0]]=[];_this.rebinds["ccontroller"][dest[1]].push(callBack);_this.rebinds["ccontroller"].push(callBack);return true}if((dest[0]!=""||dest[0]!=undefined)&&(dest[1]!=""||dest[1]!=undefined)){var ind=dest[0]+"/"+dest[1];if(_this.rebinds["controller_and_method"][ind]==
undefined)_this.rebinds["controller_and_method"][ind]=[];_this.rebinds["controller_and_method"][ind].push(callBack);return true}return false};this.$.$=this;_this.jQuery(document).ready(function(){_this.params.loadedTime=Math.round((new Date).getTime()/1E3);_this.jQuery(window).bind("popstate",function(e){if(now()-_this.params.loadedTime>1)_this.processInternalLink(window.location)});_this.jQuery("html").click(_this.linkClick);_this.reloaded()});return this.$}}();
