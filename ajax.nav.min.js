/**
* x13AjaxNav.js - Класс аякс-навигации по сайту и автоматического биндинга событий
*
* @author					Marat K. (frostosx, klyde13, icecrust13)
* @license					GNU GPL 3: http://www.gnu.org/licenses/gpl.html
* @contacts					klyde13[]gmail.com
*
* {
* 	Требует чтобы ajax-ответ с сервера являлся JSON-объектом со следующими полями:
* 		~ controller 		- имя контроллера
* 		~ method 			- имя метода
* 		~ content 			- контент для страницы
* 		~ [title] 			- опциональное поле, title для страницы
* 		~ [destinationNode] - опциональное поле, определяющее целевой html-элемент
* }
*
* @param object	params -	объект для хранения служебной информации
* {
*	должен содержать поля:
*		~ base_url		- корневой URL сайта, например "http://example.com/"
*		~ controller	- текущий открытый контроллер, например "profile"
*		~ method		- текущий открытый метод контроллера, например "view"
* }
*
* @param object jQuery -	объект jQuery
* @class x13AjaxNav
*/
window.$$$=function(){return function(t,n){var r=this;r.params=t;r.jQuery=n;r.global=function(){return this}();this.navEffect=function(){};this.navDisEffect=function(){};this.processAjaxResponse=function(e){if(typeof e.redirect!="undefined"){history.replaceState(null,null,link);return r.processInternalLink(e.redirect,true)}r.params.controller=e.controller;r.params.method=e.method;if(typeof e.title!="undefined")r.jQuery("title").html(e.title);if(typeof e.content!="undefined"){var t;if(typeof e.destinationNode!="undefined")t=e.destinationNode;else t=r.jQuery("#showContentSpan")?"#showContentSpan":"body";r.jQuery(t).html(e.content)}if(typeof r.processAjaxResponseInterlayer=="function")r.processAjaxResponseInterlayer(e);r.reloaded();r.lastOk=true};this.processAjaxResponseInterlayer=function(e){};this.processError=function(e){alert("ошибка выполнения запроса")};this.isBaseURL=function(e){return(e+"").toLowerCase().indexOf(r.params.base_url.toLowerCase())===0};this.processInternalLink=function(e){if(!r.isBaseURL(e))return false;r.lastOk=false;if(typeof r.navEffect=="function")r.navEffect();$.ajax({type:"GET",dataType:"JSON",url:e,async:false,success:r.processAjaxResponse,error:r.processError});if(typeof r.navEffect=="function")r.navDisEffect();return r.lastOk};this.linkClick=function(e){var t=r.jQuery(e.target);if(t.prop("tagName")==="IMG"&&t.parent().prop("tagName")==="A")t=r.jQuery(t.parent());if(t.prop("tagName")!=="A")return true;var n=t.prop("href");if(!r.isBaseURL(n))return true;if(!t.hasClass("ajaxNav")&&!t.parent().hasClass("ajaxNav"))return true;if(r.processInternalLink(n))history.pushState(null,null,n);e.stopPropagation();return false};this.reloaded=function(){var e;for(var e in r.rebinds["*"])r.rebinds["*"][e]();t=r.params.controller.toLowerCase();for(e in r.rebinds["c"][t])if(typeof r.rebinds["c"][t][e]=="function")r.rebinds["c"][t][e].apply(r.global,[]);var t=(r.params.controller+"/"+r.params.method).toLowerCase();for(e in r.rebinds["cm"][t])r.rebinds["cm"][t][e].apply(r.global,[]);var t=r.params.method.toLowerCase();for(e in r.rebinds["m"][t])r.rebinds["m"][t][e].apply(r.global,[])};this.$=function(e,t){if(typeof t!=="function")return false;if(r.rebinds==undefined)r.rebinds={};if(r.rebinds["*"]==undefined)r.rebinds["*"]=[];if(r.rebinds["m"]==undefined)r.rebinds["m"]={};if(r.rebinds["c"]==undefined)r.rebinds["c"]={};if(r.rebinds["cm"]==undefined)r.rebinds["cm"]={};if(e=="*"){r.rebinds["*"].push(t);return true}e=e.split("/");if((!e[0]||e[0]=="*")&&!e[1]){if(r.rebinds["m"][e[1]]==undefined)r.rebinds["m"][e[1]]=[];r.rebinds["m"][e[1]].push(t);return true}if(e[0]&&(!e[1]||e[1]=="*")){if(r.rebinds["c"][e[0]]==undefined)r.rebinds["c"][e[0]]=[];r.rebinds["c"][e[1]].push(t);r.rebinds["c"].push(t);return true}if(e[0]&&e[1]){var n=e[0]+"/"+e[1];if(r.rebinds["cm"][n]==undefined)r.rebinds["cm"][n]=[];r.rebinds["cm"][n].push(t);return true}return false};this.$.$=this;r.jQuery(document).ready(function(){r.params.loadedTime=Math.round((new Date).getTime()/1e3);r.jQuery(r.global).bind("popstate",function(e){if(now()-r.params.loadedTime>1)r.processInternalLink(r.global.location)});r.jQuery("html").click(r.linkClick);r.reloaded()});return this.$}}();